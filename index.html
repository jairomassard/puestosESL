<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- <meta http-equiv="X-UA-Compatible" content="IE=edge">-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="image/x-icon" href="IQSpaces_fabicon_v3.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <title>Reserva de Puestos T.</title>
    <link rel="stylesheet" href="css/estilo.css">
    <!--<script src="js/scripts.js"></script>-->
    <script src="js/md5.js"></script>


</head>

<body>
    <div>
        <label>
            <h5></h5>
        </label>
    </div>

    <div class="container">
        <div class="row align-items-end">
            <div class="col">
                <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjAi9Vh52hPwNrUWCLpU6BMtzX6qkGbyMBXQ2QVoiLNtYLxZ7msK6DfPbP-oMOtQjP9POFNLZaqUS1XyJXUodbPwQ_KADyZfHRD2yhymjIM2I1M4bsOjFAPh4yC5YWTkFzyNLto4P9_oGKWGaxeEXZr6ftDQUGLQob9SYFuo8RYk_5onGE7o8vYSAhO/w633-h245/IQ_Spaces_Def_prueba%20cambio%20colores.png"
                    alt="Logo" title="Foto tomada por Jairo" width="300" height="120" />
            </div>
            <div class="col">
            </div>
            <div class="col">
            </div>
            <h1>Sistema de Cargue de Información - Etiquetas electrónicas</h1>
            <h1></h1>
            <br />
            <div class="col">
                <h2>Reserva Puestos de Trabajo</h2>
                <br />
                <form action="" id="transationform">

                    <div>
                        <label for="itemName">ID Puesto de Trabajo</label>
                        <select class="form-select" name="itemName" id="itemName">
                            <option value="PT01">PT01</option>
                            <option value="PT02">PT02</option>
                            <option value="PT03">PT03</option>
                            <option value="PT04">PT04</option>
                            <option value="PT05">PT05</option>
                            <option value="PT06">PT06</option>
                        </select>
                    </div>
                    <div>
                        <label>
                            <h5></h5>
                        </label>
                    </div>


                    <div class="input-group mb-3">
                        <span class="input-group-text" id="eatMethod">Fecha de Ocupación</span>
                        <input type="date" class="form-control" name="eatMethod" />
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="itemBaseUnit">Hora Inicio</span>
                        <input type="time" class="form-control" name="itemBaseUnit" />
                        <span class="input-group-text" id="storageCondition">Hora Fin</span>
                        <input type="time" class="form-control" name="storageCondition" />
                    </div>

                    <div class="input-group mb-3">
                        <span class="input-group-text" id="mixture">Persona que Reserva</span>
                        <input type="text" class="form-control" name="mixture" placeholder="Nombre y Apellido" required size="30"
                            maxlength="30" aria-label="Nombre y Apellido" aria-describedby="mixture" />

                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="goodsNo">Cargo (Opcional)</span>
                        <input type="text" class="form-control" name="goodsNo" placeholder="Cargo" required size="30"
                            maxlength="30" aria-label="Cargo" aria-describedby="goodsNo" />

                    </div>

                    <div>
                        <label for="grade">Estado de Ocupación</label>
                        <select class="form-select" name="grade" id="grade">
                            <option value=""></option>
                            <option value="DISPONIBLE">DISPONIBLE</option>
                        </select>
                    </div>
                    <div>
                        <br />
                        <button type="button" onclick="cargar()" class="btn btn-danger">Cargue/Edición
                            Información</button>

                        <br />
                    </div>
            </div>
            <div class="col">

                <img src="https://blogger.googleusercontent.com/img/a/AVvXsEjmrq9w8lzXalKwHBqk3NSokML-mOvTPQgMwUpe0zua_hnCnVnYVRblWm8lXmiVOwBvDJV-4TZxEd-8ti7NXAcjyvx-mNtekmQbAy9kJigVTIm9qzAhgXZCSTlEtsCcSOj9mMOuhZo3qXzByfualihU50IhWa0ztk8nm3vdFYl1n36HlYREC9c6nOd-=w405-h204"
                    alt="Foto Etiqueta" title="Templae IQ SPACES" width="600" height="290" />
            </div>

        </div>

        <br />
        </form>
        <br />
        <br />
        <div class="formatotabla">
            <table id="transactionTable">
                <tr>
                    <th>
                        Puesto de Trabajo
                    </th>
                    <th>
                        Fecha de Reserva
                    </th>
                    <th>
                        Hora Inicio
                    </th>
                    <th>
                        Hora Fin
                    </th>
                    <th>
                        Persona que Reserva
                    </th>
                    <th>
                        Cargo
                    </th>
                    <th>
                        Estado de Ocupación
                    </th>
                    <th>
                        Fecha envio Info
                    </th>

            </table>

        </div>

        <script>


            //CALCULO FORMATO FECHA

            var fecha = new Date();
            fecha.setHours(fecha.getHours() + 13);

            //document.getElementById("demo").innerHTML = fecha;

            var hoy = fecha.getDate();
            var mesActual = fecha.getMonth() + 1;
            //const hora = fecha.getHours();
            const year = fecha.getFullYear();
            //const year2 = fecha.

            if (mesActual < 10) mesActual = '0' + mesActual;
            if (hoy < 10) hoy = '0' + hoy;

            const formatofecha = year + "-" + mesActual + "-" + hoy;
            //document.getElementById("demo").innerHTML = formatofecha;


            //SCRIPTS de la pagina

            const form = document.getElementById("transationform");
            //console.log(form)

            function cargar() {
                alert("Envio exitoso de formulario");
                //event.preventDefault();
                let transactionFormData = new FormData(form);
                let transactionObj = convertFormDataToTransactionObj(transactionFormData);
                //console.log(transactionObj);
                //console.log(transactionObj);
                saveTransactionObj(transactionObj);
                insertRowInTransactionTable(transactionObj);
                EnviarYalaInfo(transactionObj);
                //form.reset()
            }

            document.addEventListener("DOMContentloaded", function (event1) {
                let transactionObjArr = [JSON.parse(localStorage.getItem("transactionData"))];
                transactionObjArr.forEach(
                    function (arrayElement) {
                        insertRowInTransactionTable(arrayElement);
                        //console.log(arrayElement);
                        //console.log("Se insertan elementos desde localStorage")
                    }
                )
            }
            )



            function convertFormDataToTransactionObj(transactionFormData) {

                let itemName = transactionFormData.get("itemName");
                let itemBarCode = itemName;
                let merchantGoodsId = itemName;
                let merchantGoodsCategoryId = itemName;
                let eatMethod = transactionFormData.get("eatMethod");
                let itemBaseUnit = transactionFormData.get("itemBaseUnit");
                let storageCondition = transactionFormData.get("storageCondition");
                let mixture = transactionFormData.get("mixture");
                let goodsNo = transactionFormData.get("goodsNo");
                let grade = transactionFormData.get("grade");
                let categoryName = "Puesto de Trabajo";
                return {
                    "itemName": itemName,
                    "itemBarCode": itemBarCode,
                    "merchantGoodsId": merchantGoodsId,
                    "merchantGoodsCategoryId": merchantGoodsCategoryId,
                    "eatMethod": eatMethod,
                    "itemBaseUnit": itemBaseUnit,
                    "storageCondition": storageCondition,
                    "mixture": mixture,
                    "goodsNo": goodsNo,
                    "grade": grade,
                    "categoryName": categoryName
                }
            }


            function insertRowInTransactionTable(transactionObj) {

                let transactionTableRef = document.getElementById("transactionTable");

                let newtransactionRowRef = transactionTableRef.insertRow(-1);

                newTypeCellRef = newtransactionRowRef.insertCell(0);
                newTypeCellRef.textContent = transactionObj["itemName"];

                newTypeCellRef = newtransactionRowRef.insertCell(1);
                newTypeCellRef.textContent = transactionObj["eatMethod"];

                newTypeCellRef = newtransactionRowRef.insertCell(2);
                newTypeCellRef.textContent = transactionObj["itemBaseUnit"];

                newTypeCellRef = newtransactionRowRef.insertCell(3);
                newTypeCellRef.textContent = transactionObj["storageCondition"];

                newTypeCellRef = newtransactionRowRef.insertCell(4);
                newTypeCellRef.textContent = transactionObj["mixture"];

                newTypeCellRef = newtransactionRowRef.insertCell(5);
                newTypeCellRef.textContent = transactionObj["goodsNo"];

                newTypeCellRef = newtransactionRowRef.insertCell(6);
                newTypeCellRef.textContent = transactionObj["grade"];

                newTypeCellRef = newtransactionRowRef.insertCell(7);
                newTypeCellRef.textContent = new Date();

            }

            function saveTransactionObj(transactionObj) {
                //Jalo lo que hay en el Local Storage, lo convierto a Variable y lo asigno a un array de transacciones
                let myTransactionArray = [JSON.parse(localStorage.getItem("transactionData"))] || [];
                myTransactionArray.push(transactionObj);
                //convierto mi Array de transacciones a JSON
                let transactionArrayJSON = JSON.stringify(myTransactionArray);
                //Guardo mi array de transacciones en formato JSON en Local storage
                //localStorage.setItem("transactionData", transactionArrayJSON)

            }
            //genera y asigna el MD5 para el APP

            let hash1 = md5("83C3A53C05553cb" + formatofecha);
            console.log(hash1)

            function EnviarYalaInfo(transactionObj) {
                var myHeaders = new Headers();
                myHeaders.append("veryText", hash1);
                myHeaders.append("merchantCode", "MC1220");
                myHeaders.append("type", "1");
                myHeaders.append("content-type", "application/json");

                var raw = JSON.stringify([transactionObj]);
                console.log(raw)

                var requestOptions = {
                    method: 'POST',
                    headers: myHeaders,
                    body: raw,
                    redirect: 'follow'
                };

                fetch("https://sg.yalabi.net/open/saveOrGoods", requestOptions)
                    .then(response => response.json())
                    .then(result => console.log(result))
                    .catch(error => console.log('error', error));

            };

        </script>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2"
            crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.5/dist/umd/popper.min.js"
            integrity="sha384-Xe+8cL9oJa6tN/veChSP7q+mnSPaj5Bcu9mPX5F5xIGE0DVittaqT5lorf0EI7Vk"
            crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.min.js"
            integrity="sha384-kjU+l4N0Yf4ZOJErLsIcvOU2qSb74wXpOhqTvwVx3OElZRweTnQ6d31fXEoRD1Jy"
            crossorigin="anonymous"></script>

</body>

</html>
